# AWS VPCトラフィックミラーリングのための例示的なWallarmソリューションのサブモジュール

**情報** これは、Terraformモジュールまたはモジュールの例設定ではありません。この文書は、AWS VPCによるミラーリングトラフィックを扱うための`terraform-aws-wallarm`モジュールの実行に必要なサブモジュールの詳細情報を提供します。

`vpc-mirror-rebuild`サブモジュールは、VXLANパケットストリームからHTTPリクエストを再構築し、それらのリクエストをミラーリングされたトラフィックを分析する設定を行ったWallarmノードへと渡す役割を果たすノードを実行します。

## 説明

このモジュールには、Debian 10 AMIを基盤とするAutoscaling Groupと`goreplay`を自動的にインストールするためのcloud-initスクリプトが含まれています。

`cloud-init.tftpl`には、cloud-initスクリプトの基本的なテンプレートが含まれ、以下のような作業を行います：

* 必要なパッケージのセットをインストールします。
* `goreplay`をインストールします（この例はリリース時点で、`vxlan`機能がマスターブランチでのみ利用可能なため、ソースからビルドします）。
* インスタンスの再起動直後に`goreplay`を動作させる設定をします。
* ロードバランサーのヘルスチェックを設定します。

## 使用詳細

このモジュールはいくつかのカスタマイズオプションをサポートしており、以下の内容を設定することが可能です：

* 垂直スケーリングを行うための`instance_type`と、EC2インスタンスの配置場所を定める`subnet_ids`。これらのインスタンスはプライベートサブネットに配置することを推奨します。
* `mirror_endpoint`変数。これは、抽出されたHTTPリクエストをWallarmノードへ送るためのエンドポイントとなります。

このアプリケーションを適切に設定するために、`vxlan_id`、`buffer_packet_expire`、および`buffer_size`も定義することが出来ます：

* `vxlan_id`は、VXLAN VNIを定義することが可能です。これは、一つのロードバランサーやインスタンスに複数のVXLANストリームが存在する場合に有用です。
* `buffer_packet_expire`と`buffer_size`でバッファーの上限を設定します。

また、`debug`オプションも設定できます。これにより、systemdデーモンの`goreplay`アプリケーションのログの詳細度が有効になります（インスタンス上で`journalctl -xefu goreplay.service`を利用します）。