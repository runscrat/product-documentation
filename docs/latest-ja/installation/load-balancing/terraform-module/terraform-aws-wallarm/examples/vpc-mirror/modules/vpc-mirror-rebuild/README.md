# AWS VPCトラフィックミラーリングのためのWallarmソリューションの例のサブモジュール

**情報** これはTerraformモジュールやモジュールの例の設定ではありません。このドキュメントはAWS VPCでミラーリングされたトラフィックのための `terraform-aws-wallarm` モジュールを実行するために必要なサブモジュールの詳細を提供します。

`vpc-mirror-rebuild`サブモジュールは、VXLANパケットストリームからHTTPリクエストを再構築し、これらのリクエストをミラーリングされたトラフィックの分析のために設定されたWallarmノードに渡すことができるノードを実行します。

## 説明

モジュール内には、Debian 10 AMIに基づくAutoscaling Groupと、自動的に `goreplay`をインストールするcloud-initスクリプトが含まれています。

`cloud-init.tftpl` には、次の機能を持つcloud-initスクリプトの基本的なテンプレートがあります：

* 必要なパッケージセットをインストールする
* `goreplay` をインストールする（ソースからビルド、 `vxlan` 機能は現時点ではマスターブランチでのみ利用可能)
* インスタンスの再起動直後に `goreplay` が動作するように設定する。
* ロードバランサーのヘルスチェックを設定する。

## 使用の詳細

このモジュールはいくつかのカスタマイズオプションをサポートしています。次のように設定できます：

* 垂直スケーリングのための `instance_type` と、EC2インスタンスを配置する場所を定義するための `subnet_ids`。私たちはこれらのインスタンスをプライベートサブネットに配置することをお勧めします。
* `mirror_endpoint` 変数。これは、抽出されたHTTPリクエストをWallarmノードに渡すためのエンドポイントです。

このアプリケーションを適切に設定するためには、 `vxlan_id` 、 `buffer_packet_expire` 、 `buffer_size` を定義することができます：

* `vxlan_id` はVXLAN VNIを定義することができます。これは単一のロードバランサーやインスタンスで複数のVXLANストリームがある場合に役立つことがあります。
* `buffer_packet_expire` と `buffer_size` はバッファーの制限を設定します。

`debug` オプションも設定できます。これにより、systemdデーモン内の `goreplay` アプリケーションのログの詳細度が有効になります（インスタンス上で `journalctl -xefu goreplay.service` を使用します）。