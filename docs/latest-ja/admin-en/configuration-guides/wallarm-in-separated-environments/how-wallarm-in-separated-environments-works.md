# 分離した環境でのフィルタリングノードの動作方法

アプリケーションは、プロダクション、ステージング、テスト、開発など、いくつかの異なる環境にデプロイされることがあります。これらの指示は、さまざまな環境でフィルタノードを管理するための推奨される方法についての情報を提供します。

## 環境とは何か
環境の定義は企業により異なり、この指示の目的のため、以下の定義を使用します。

**環境**とは、異なる目的（例：プロダクション、ステージング、テスト、開発など）で利用され、同じまたは異なる一連のポリシー（ネットワーク/ソフトウェア設定、ソフトウェアバージョン、監視、変更管理など）により管理されているコンピューティングリソースの独立したセットまたはサブセットで、同一または異なるチーム（SRE、QA、開発など）が企業の一部としてこれを管理します。

ベストプラクティスの観点からは、Wallarmノードの設定を単一の製品縦列で使用されるすべての環境（開発、テスト、ステージングおよびプロダクションステージ）で同期させておくことを推奨します。

## Wallarmの関連機能

異なる環境で異なるフィルタノード設定を管理し、フィルタノード変更の段階的なロールアウトを行うための3つの主要な機能があります：

* [リソース識別](#リソース識別)
* [別々のWallarmアカウントとサブアカウント](#別々のwallarmアカウントとサブアカウント)
* [フィルタノード運用モード](../../configure-wallarm-mode.md)

### リソース識別

特定の環境に対するフィルタノード設定を行うための2つの方法があります：

* それぞれの環境に対するWallarm固有のID
* 環境の異なるURLドメイン名（既にあなたのアーキテクチャに設定されている場合）。

#### IDによる環境識別

アプリケーションのコンセプトにより、異なる保護環境に異なるIDを割り当て、各環境別にフィルタノードルールを管理することができます。

フィルタノードを設定する際には、アプリケーションの概念を使用して環境にWallarm IDを追加することができます。IDの設定方法は次の通りです：

1. Wallarmアカウント → **設定** → **アプリケーション** セクションで、環境名とそのIDを追加します。

    ![追加した環境](../../../images/admin-guides/configuration-guides/waf-in-separate-environments/added-applications.png)
2. フィルタノードでID設定を行います：

    * Linuxベース、Kubernetesサイドカー、Dockerベースデプロイメント用の[`wallarm_application`](../../configure-parameters-en.md#wallarm_application)ディレクティブを使用。
    * Kubernetes NGINX Ingressコントローラー用の[`nginx.ingress.kubernetes.io/wallarm-application`](../../configure-kubernetes-en.md#ingress-annotations)注釈を使用。新しいフィルタノードルールを作成する際に、ルールが特定のアプリケーションIDのセットに割り当てられるよう指定できます。属性がない場合、新しいルールは自動的にWallarmアカウント内のすべての保護されたリソースに適用されます。

![ID用のルール作成](../../../images/admin-guides/configuration-guides/waf-in-separate-environments/create-rule-for-id.png)

#### ドメインによる環境識別

各環境が異なるURLドメイン名を使用し、それが `HOST` HTTPリクエストヘッダーで受け渡される場合、ドメイン名を各環境の一意の識別子として使用することが可能です。

この機能を使用するためには、設定された各フィルタノードルールに適切な`HOST`ヘッダーポインタを追加してください。以下の例では、`HOST`ヘッダーが`dev.domain.com`のリクエストのみでルールがトリガーされます：

![HOST用のルール作成](../../../images/admin-guides/configuration-guides/waf-in-separate-environments/create-rule-for-host.png)

### 別々のWallarmアカウントとサブアカウント

異なる環境のフィルタノード設定を分離する簡単な選択肢として、各環境もしくは環境のグループごとに別々のWallarmアカウントを使用することができます。このベストプラクティスは、Amazon AWSを含む多くのクラウドサービス提供者によって推奨されています。

複数のWallarmアカウントの管理を簡単にするために、論理的に`master` Wallarmアカウントを作成し、他の使用中のWallarmアカウントを`master`アカウントのサブアカウントとして割り当てることが可能です。これにより、単一のコンソールUIとAPIの認証情報セットを使用して、組織が所有するすべてのWallarmアカウントを管理することができます。

`master`アカウントおよびサブアカウントを有効化するには、[Wallarmのテクニカルサポート](mailto:support@wallarm.com)チームにご連絡ください。この機能は、別途Wallarmエンタープライズライセンスが必要です。

!!! warning "既知の制限"
    * 同じWallarmアカウントに接続されたすべてのフィルタノードは、同じセットのトラフィックフィルタリングルールを受け取ります。適切な[アプリケーションIDまたは一意のHTTPリクエストヘッダー](#リソース識別)を使用することで、異なるアプリケーションに対して異なるルールを適用することも可能です。
    * フィルタノードがIPアドレスを自動的にブロックを決定した場合（例えば、同一のIPアドレスから3つ以上の攻撃ベクトルが検出された場合）、システムはそのIPをWallarmアカウント内のすべてのアプリケーションでブロックします。