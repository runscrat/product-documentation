[link-points]:          points/intro.md
[link-ruby-regexp]:     http://ruby-doc.org/core-2.6.1/doc/regexp_rdoc.html
[link-ext-logic]:       logic.md

[img-collect-uniq]:    ../../images/fast/dsl/en/phases/collect-uniq.png

# 収集フェーズ

!!! info "フェーズの範囲"
    このフェーズは変更拡張子で使用され、その機能にはオプショナルです（`collect`セクションはYAMLファイルに存在しないか、存在するかのいずれかです）。

    また、このフェーズは唯一性条件を使用する非変更拡張子によって暗黙的に使用されます。

    拡張子タイプについて詳しくは[こちら][link-ext-logic]をご覧ください。

!!! info "リクエスト要素の記述構文"
    FAST拡張子を作成するとき、アプリケーションに送信されるHTTPリクエストの構造と、アプリケーションから受信するHTTPレスポンスの構造を理解し、ポイントを使用して作業する必要のあるリクエスト要素を正確に記述する必要があります。

    詳しい情報は、この[リンク][link-points]を参照してください。

このフェーズでは、指定された条件を満たすすべての基準リクエストが収集されます。リクエストの収集についての決定を行うために、このフェーズではテスト実行中にすでに収集されたリクエストに関する情報を使用します。

基準リクエストの収集手順はリアルタイムで行われます。すべてのリクエストは、FASTノードが基準リクエストを書き込む順序で処理されます。リクエストが処理され、収集フェーズで収集されるためには、リクエストの書き込みプロセスが完了するのを待つ必要はありません。

## ユニーク条件

ユニーク条件では、指定された基準によりユニークでないと判断された基準リクエストが、残りのフェーズでの処理に進むことを許可していません。これらのフィルタリングされたリクエストのためにテストリクエストは生成されません。これは、同じタイプの基準リクエストが複数送信された場合のターゲットアプリケーション負荷の軽減に役立つ場合があります。

受信した各リクエストのユニーク性は、以前に受信したリクエストのデータに基づいて決定されます。

![収集フェーズとユニーク条件][img-collect-uniq]

ベースラインリクエストのユニーク性を決定するために使用する必要があるリクエストの要素のリストは、ユニーク条件で定義されます。

ベースラインリクエストを受信すると、収集フェーズの拡張子はリスト内のリクエストの各要素に対して以下のアクションを実行します：
1. ベースラインリクエストにそのような要素がない場合は、リストの次の要素に進みます。
2. ベースラインリクエストにそのような要素があり、その要素のデータがユニークである（つまり、以前に受信したベースラインリクエストのデータと一致しない）場合、このベースラインリクエストをユニークとして扱い、次のフェーズに転送します。このリクエスト要素のデータを記憶します。
3. ベースラインリクエストにそのような要素が存在し、その要素のデータがユニークでない場合（つまり、以前に受信した基準リクエストのデータと一致する場合）、この基準リクエストを破棄します。これは、ユニーク条件を満たさないためです。指定されたリクエストに対して拡張子は実行されません。
4. リストの終わりに到達し、ユニーク性をチェックできるリクエスト要素が見つからなかった場合、この基準リクエストを破棄します。このリクエストに対して拡張子は実行されません。

`uniq` リストを使用して、拡張子のYAMLファイルの`collect`セクションでユニーク条件を記述することができます。このリストには、基準リクエストのユニーク性が決定される要素が含まれています。

```
collect:
  - uniq:
    - [リクエスト要素]
    - [リクエスト要素1, リクエスト要素2, …, リクエスト要素N]
    - testrun
```

リスト内のリクエスト要素には、Rubyの正規表現フォーマットの[正規表現][link-ruby-regexp]を含めることができます。

`uniq` ユニーク条件は、基準リクエストのユニーク性をチェックするために使用されるデータを含むリクエスト要素の配列を構成します。`testrun` パラメータも使用できます。

ユニーク条件のパラメータは次のとおりです：

* **`- [リクエスト要素]`**
    
    リクエストはリクエスト要素でユニークなデータを含む必要があります。これにより、リクエストがユニークとして扱われます。
    
    ??? info "例"
        `- [GET_uid_value]` — リクエストのユニーク性は`uid`GETパラメータのデータによって定義されます（つまり、拡張子は`uid`GETパラメータのユニークな値を持つそれぞれの基準リクエストに対して実行する必要があります）。

        * `example.com/example/app.php?uid=1`はユニークなリクエストです。
        * `example.com/demo/app.php?uid=1`はユニークなリクエストではありません。
        * `example.com/demo/app.php?uid=`はユニークなリクエストです。
        * `example.org/billing.php?uid=1`はユニークなリクエストではありません。
        * `example.org/billing.php?uid=abc`はユニークなリクエストです。

* **`- [リクエスト要素1, リクエスト要素2, …, リクエスト要素N]`**
    
    リクエストはN個の要素のセットを含むべきであり、それぞれのセットに含まれるリクエスト要素のデータがユニークであるべきです。これにより、リクエストがユニークとして扱われます。
    
    ??? info "例1"
        `- [GET_uid_value, HEADER_COOKIE_value]` — リクエストのユニーク性は、`uid` GETパラメータのデータと`Cookie` HTTPヘッダのデータによって決定されます（つまり、拡張子は`uid` GETパラメータと`Cookie` ヘッダのユニークな値を持つそれぞれの基準リクエストに対して実行する必要があります）。

        * `example.org/billing.php?uid=1, Cookie: client=john`はユニークなリクエストです。
        * `example.org/billing.php?uid=1, Cookie: client=ann`はユニークなリクエストです。
        * `example.com/billing.aspx?uid=1, Cookie: client=john`はユニークなリクエストではありません。
    
    ??? info "例2"
        `- [PATH_0_value, PATH_1_value]` — 最初と2番目のパス要素のペアによってリクエストのユニーク性を定義します（つまり、 `PATH_0`と`PATH_1`パラメータのユニークな値を持つそれぞれの基準リクエストに対して拡張子を実行します）。

        Wallarmは要素処理中にリクエスト要素のパースを行います。 `/en-us/apps/banking/`の形式の各URIパスについて、Pathパーサーはパス要素をPATH配列に入れます。

        それぞれの配列要素の値にはインデックスを使用してアクセスできます。 以前に言及した`/en-us/apps/banking/`パスについて、パーサーは次のデータを提供します：

        * `"PATH_0_value": "en-us"`
        * `"PATH_1_value": "apps"`
        * `"PATH_2_value": "banking"`

        したがって、 `[PATH_0_value, PATH_1_value]`のユニーク条件は、パスの第一要素と第二要素の値が異なるすべてのリクエストに対して満たされます。

        * `example.com/en-us/apps/banking/charge.php`はユニークなリクエストです。
        * `example.com/en-us/apps/banking/vip/charge.php`はユニークなリクエストではありません。
        * `example.com/de-de/apps/banking/vip/charge.php`はユニークなリクエストです。

* **`- testrun`**

    テストリクエストが正常に作成された場合（つまり、他のすべてのフェーズが通過した場合）、拡張子はテストランの間に一度実行されます。

    例えば、Matchフェーズで基準リクエストが破棄されるため、受信した基準リクエストに基づいてテストリクエストを生成できない場合、Collectフェーズの拡張子は基準リクエストの収集を続け、そのうちの一つがMatchフェーズを通過し、それに基づいてターゲットアプリケーションのテストリクエストが作成されるまで続けます。

    `testrun`パラメータをすでに使用している場合は、`uniq`リスト内のリクエスト要素を使用することは許可されません。 `uniq`ユニーク条件は単一の要素を含むようになります。

    ```
    collect:
      - uniq:
        - testrun 
    ```

    `uniq`リストに複数の要素がある場合、リクエストがユニークとして定義されるためには、`uniq`リストから少なくとも一つのユニークなパラメータを持つ必要があります。



!!! info "収集フェーズのパラメータ"
    現在、収集フェーズでサポートされているのは、受信した基準リクエストのユニーク条件のみです。将来的には、このフェーズの機能が拡張される可能性があります。