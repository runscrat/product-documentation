[link-points]:          points/intro.md
[link-ruby-regexp]:     http://ruby-doc.org/core-2.6.1/doc/regexp_rdoc.html
[link-logic]:           logic.md
[link-markers]:         detect/markers.md
[link-ext-logic]:       logic.md

[img-generate-methods]:     ../../images/fast/dsl/en/phases/generate-methods.png
[img-generate-payload]:     ../../images/fast/dsl/en/phases/generate-payload.png

# 生成フェーズ

!!! info "フェーズの範囲"
    このフェーズは修正型の拡張に使用され、その操作にオプショナルです（`generate`セクションはYAMLファイルに存在してもなくても構いません）。

    非修正型の拡張のYAMLファイルにはこのフェーズを含めないでください。
    
    拡張のタイプについて詳しくは[こちら][link-ext-logic]をご覧ください。

!!! info "リクエスト要素の記述文法"
     FAST拡張を作成する際には、アプリケーションに送信するHTTPリクエストと、アプリケーションから受信するHTTPレスポンスの構図を理解し、ポイントを使用して作業したいリクエスト要素を正しく記述する必要があります。
     
     詳細情報は[こちら][link-points]のリンクをご覧ください。
 
 このフェーズでは、ベースラインリクエストの特定のパラメーターに挿入するプレイロードが指定されます。これにより、このリクエストを基にしたテストリクエストが作成されます。

`generate`セクションの構成は次のとおりです：

```
generate:
  - into:
    - パラメーター 1
    - パラメーター 2
    - …
    - パラメーター N
  - method:
    - postfix
    - prefix
    - random
    - replace
  - payload:
    - プレイロード 1
    - プレイロード 2
    - …
    - プレイロード N
```

* `into`パラメーターは、単一または複数のリクエスト要素を指定でき、これらの要素にプレイロードを挿入します。このパラメーターの値は文字列または文字列の配列にすることができます。[Ruby形式の正規表現][link-ruby-regexp]を`into`パラメーターの値として使用することができます。
    
    このパラメーターはオプショナルであり、セクションには含まれていないかもしれません。`into`パラメーターが省略されている場合、プレイロードは、テストポリシーに基づいて変更可能なリクエスト要素に挿入されます。
    
    テストポリシーによりベースラインリクエストから以下の mutable リクエスト要素が抽出されたと仮定します：
    
    * `GET_uid_value`
    * `HEADER_COOKIE_value`
    
    拡張は、挿入ポイントとも呼ばれる、これらの mutable 要素を順次処理します。
    
    `into`パラメーターが省略されている場合、プレイロードは次に`GET_uid_value`パラメーターに順次貼り付けられ、生成されたテストリクエストを使用して対象アプリケーションに対する脆弱性をチェックします。その後、テストリクエストの結果が処理された後、拡張は`HEADER_COOKIE_value`パラメーターを処理し、このパラメーターにも同様にプレイロードを挿入します。
    
    `into`パラメーターが以下の例のように`GET_uid_value`リクエストパラメーターを含んでいる場合、プレイロードは`GET_uid_value`パラメーターに挿入されますが、`HEADER_COOKIE_value`パラメーターには挿入されません。
    
    ```
    into: 
      - 'GET_uid_value'
    ```
    以下の例にはパラメーターが一つしか含まれていないため、into パラメーターの値は一行で書くことができます：
    
    `into: 'GET_uid_value'`

* `method` — このオプショナルなパラメーターは、プレイロードをベースラインリクエストの要素に挿入する方法を指定します。
    * `prefix` — ベースラインリクエスト要素の値の前にプレイロードを挿入します。
    * `postfix` — ベースラインリクエスト要素の値の後にプレイロードを挿入します。
    * `random` — ベースラインリクエスト要素の値のランダムな位置にプレイロードを挿入します。
    * `replace` — ベースラインリクエスト要素の値をプレイロードに置き換えます。

    ![プレイロードの挿入方法][img-generate-methods]
    
    `method`パラメーターが省略されている場合、デフォルトで`replace`メソッドが使用されます。

    テストリクエストを作成するための要求の数は、指定された`methods`の数に依存します：挿入方法ごとに一つのテストリクエスト。

    例えば、以下の挿入方法が指定されている場合：
    
    ```
    method:
      - prefix
      - replace
    ```

    一つのプレイロードに対しては二つのテストリクエストが作成され、二つのプレイロードに対しては四つのテストリクエストが作成されます（プレイロードごとに二つのテストリクエスト）、など。

* `payload`パラメーターは、リクエストパラメーターに挿入するためのプレイロードのリストを指定します。これにより、対象アプリケーションに対する脆弱性をテストするテストリクエストが作成されます。
    
    このパラメーターは必須であり、セクションに常に存在していなければなりません。リストには最低一つのプレイロードを含める必要があります。プレイロードが複数ある場合、FASTノードは順次プレイロードをリクエストパラメーターに挿入し、それぞれのテストリクエストを使用して対象アプリケーションに対する脆弱性をテストします。
    
    ![プレイロードの生成][img-generate-payload]
    
    プレイロードは、リクエストの処理中にパラメーターの一つに挿入される文字列です。
    
    ??? info "複数のプレイロードの例"
        ```
        payload:
          - "') or 1=('1"
          - "/%5c../%5c../%5c../%5c../%5c../%5c../%5c../etc/passwd/"
        ```
    
    プレイロードの一部として特別なマーカーを使用することで、脆弱性検出の可能性がさらに広がります： 

    * **`STR_MARKER`** — プレイロードにランダムな文字列を挿入します。これは`STR_MARKER`が指定されている位置に挿入されます。
        
        例えば、`STR_MARKER`はアプリケーションをXXS脆弱性の確認に使用することができます。
        
        ??? info "例"
            `'userSTR_MARKER'`
    
    * **`CALC_MARKER`** — ランダムな算術式（例：`1234*100`）を含む文字列をプレイロードに挿入します。これは`CALC_MARKER`が指定されている位置に挿入されます。
        
        例えば、`CALC_MARKER`はアプリケーションがRCE脆弱性を持っているかチェックするために使用できます。
        
        ??? info "例"
            `'; bc <<< CALC_MARKER'`
    
    * **`DNS_MARKER`** — ランダムなドメイン（例：`r4nd0m.wlrm.tl`）の文字列をプレイロードに挿入します。これは`DNS_MARKER`が指定されている位置に挿入されます。
        
        例えば、`DNS_MARKER`はアプリケーションがDNS Out-of-Bound脆弱性を持っているかチェックするために使用できます。
        
        ??? info "例"
            `'; ping DNS_MARKER'`
    
    !!! info "マーカーの操作ロジック"
        Detectフェーズがサーバーのレスポンスから任意のプレイロードのマーカーを検出した場合、攻撃が成功したことを示します。つまり、脆弱性が成功裏に悪用されました。Detectフェーズがマーカーと共に操作する詳細情報については、[こちら][link-markers]のリンクを参照してください。